# 格式保持功能改进说明

## 概述

本次更新实现了两个重要需求：
1. 利用LLM提取的文字，针对不同的样式，同时记录文件的格式，并在EPUB转换时体现出来
2. 保存EPUB尽量和原始样本格式一致，不要去增加"Page3"这样的大字元素

## 功能实现

### 1. 结构化数据提取

通过 `extract_rich_structure` 方法，Gemini模型能够提取丰富的文档结构信息：

```python
[
    {
        "type": "heading",
        "level": 1,           # 标题级别
        "style": {
            "align": "center" # 文本对齐方式
        },
        "content": "译者序"
    },
    {
        "type": "paragraph",
        "level": 0,
        "style": {
            "align": "left"
        },
        "content": "本书系美国研究中国问题专家..."
    }
]
```

### 2. 智能标题提取

- 从内容块中智能提取真实章节标题
- 避免使用"Page X"这样的默认标题
- 保持原始文档的章节结构

### 3. 样式保持

- 保持标题层级关系（h1, h2, h3等）
- 应用文本对齐样式（居中、左对齐、右对齐）
- 保持段落格式和缩进

## 技术实现

### Gemini客户端增强

1. **extract_rich_structure 方法**
   - 使用专门的提示词指导Gemini返回结构化JSON数据
   - 支持标题级别识别
   - 支持文本对齐样式提取

2. **JSON格式返回**
   - 请求模型返回application/json格式
   - 自动解析和清理响应数据

### EPUB生成器增强

1. **create_epub_from_structure 方法**
   - 根据结构化数据生成HTML内容
   - 应用标题层级和样式信息
   - 保持原始文档的版面布局

2. **样式应用**
   - 动态生成CSS样式
   - 应用文本对齐属性
   - 保持标题层级关系

## 使用效果

### 改进前
```
<h1>Page 1</h1>
<p>这是第一段内容...</p>
<h1>Page 2</h1>
<p>这是第二段内容...</p>
```

### 改进后
```
<h1 style="text-align: center;">译者序</h1>
<p style="text-align: left;">这是第一段内容...</p>
<h2 style="text-align: left;">第一章 导言</h2>
<p style="text-align: left;">这是第二段内容...</p>
```

## 处理模式对比

### 富文本模式 (rich)
- 保持原始文档的标题层级
- 应用文本对齐样式
- 智能提取章节标题
- 更好地保持版面布局

### 纯文本模式 (simple)
- 使用"##"标记识别标题
- 保持段落连续性
- 兼容旧版处理流程

## 验证方法

可以通过以下方式验证格式保持效果：

1. 处理包含多级标题的PDF文件
2. 检查生成的EPUB文件中标题层级是否正确
3. 验证文本对齐样式是否保持
4. 确认章节标题是否为真实标题而非"Page X"格式

## 注意事项

1. 富文本模式需要Gemini模型支持结构化数据提取
2. 对于简单文档，两种模式效果差异不大
3. 复杂排版文档建议使用富文本模式
4. 如果遇到格式识别问题，可以尝试切换到纯文本模式