# 段落处理改进说明

## 问题背景

在处理拍照PDF时，由于页面扫描和OCR识别的原因，原本连续的段落文本可能会因为视觉排版而被错误地分割成多行。这导致生成的EPUB文件中出现不必要的换行，影响阅读体验。

## 改进方案

### 1. Gemini客户端优化

在`src/api/gemini_client.py`中，我们优化了提示词，明确指导Gemini模型：

```
请准确提取这张图片中的所有文本内容，并将其整理成流畅的文本。
请遵循以下规则：
1. 将同一个段落内因排版而断开的行合并成一个连续的段落。不要保留图片中句子中间的视觉换行。
2. 段落与段落之间用一个双换行符（一个空行）分隔。
3. 如果有明显的章节或分节标题，请在标题前使用'## '（井号后有一个空格）进行标记。
4. 只返回提取和整理后的文本内容，不要添加任何额外的注释或说明。
```

### 2. EPUB生成器优化

在`src/generator/epub_generator.py`中，我们改进了段落处理逻辑：

1. 统一换行符格式
2. 按双换行符（段落分隔符）分割内容
3. 将段落内的单换行符移除，合并为连续文本
4. 正确生成HTML段落标签

## 处理效果

### 改进前
```
这是第一段文本，由于页面排版原因，
被错误地分割成了两行。

这是第二段文本。
```

### 改进后
```
这是第一段文本，由于页面排版原因，被错误地分割成了两行。

这是第二段文本。
```

## 技术实现细节

### Gemini提示词优化
- 明确要求合并段落内因排版断开的行
- 使用双换行符作为段落分隔标准
- 保持章节标题的识别和标记

### EPUB生成器处理逻辑
- 统一处理不同操作系统的换行符（\r\n, \r, \n）
- 按段落分隔符分割文本内容
- 移除段落内的换行符，保持文本连续性
- 正确生成HTML段落结构

## 验证方法

可以通过以下方式验证段落处理效果：

1. 处理包含明显段落换行的PDF文件
2. 检查生成的EPUB文件中段落是否连续
3. 验证段落间的正确分隔

## 注意事项

1. 该优化主要针对中文文本处理
2. 对于英文文本，可能需要在合并时添加适当的空格
3. 标题识别依赖于Gemini模型的判断能力